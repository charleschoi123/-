<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <title>匹配结果 · Alsos 批量简历分析AI系统</title>
  <link href="/static/style.css" rel="stylesheet">
</head>
<body>
  <header class="hero small">
    <div class="brand"><div class="logo">AT</div><h1>ALSOS TALENT</h1></div>
  </header>

  <div class="container">
    <h2>匹配结果</h2>
    <p class="muted">本页会在后台持续接收并追加结果；完成后可下载 Excel 或 CSV。</p>

    <section class="card">
      <h3>JD 概要</h3>
      <details open>
        <summary>展开/收起</summary>
        <pre class="muted">{{ jd }}</pre>
        <p><b>补充说明：</b></p>
        <pre class="muted">{{ notes }}</pre>
        <p><b>Must-have识别：</b> {{ must }}</p>
      </details>
    </section>

    <div class="actions">
      <a id="xlsxBtn" class="btn" href="/download_excel/{{ batch_id }}" target="_blank">⬇ 下载Excel</a>
      <a id="csvBtn" class="btn" href="/download_csv/{{ batch_id }}" target="_blank">⬇ 下载CSV</a>
      <a class="btn" href="/">返回</a>
    </div>

    <table id="resultTable">
      <thead>
        <tr>
          <th>文件名</th>
          <th>姓名</th>
          <th>年龄</th>
          <th>教育背景</th>
          <th>履历概要</th>
          <th>亮点</th>
          <th>匹配度</th>
          <th>匹配度分析</th>
          <th>证据</th>
          <th>状态</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <p id="status" class="muted">正在分析中…</p>
  </div>

  <script>
    const tbody = document.querySelector('#resultTable tbody');
    function esc(s){ return (s||'').toString().replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])) }

    function renderRow(r){
      const d = r.data || {};
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${esc(r.filename)}</td>
        <td>${esc(d.name)}</td>
        <td>${esc(d.estimated_age)}</td>
        <td class="muted">${esc(d.education_brief)}</td>
        <td>${esc(d.summary)}</td>
        <td>${(d.highlights||[]).map(x=>`<div>• ${esc(x)}</div>`).join('')}</td>
        <td><b>${esc(d.overall)}</b></td>
        <td class="muted">${esc(d.fit_analysis)}</td>
        <td class="muted">${(d.evidence||[]).map(x=>`<div>“${esc(x)}”</div>`).join('')}</td>
        <td>
          ${r.ok ? '<span class="ok">OK</span>' : '<span class="err">ERR</span>'}
          <div class="muted" style="max-width:260px">
            ${(d.risk_notes||[]).map(x=>`<div>· ${esc(x)}</div>`).join('')}
          </div>
        </td>
      `;
      tbody.appendChild(tr);
      document.getElementById('status').textContent = `已完成 ${tbody.children.length} 条…`;
    }

    const mode = "{{ stream_mode or 'sse' }}";
    if (mode === 'sse') {
      const evt = new EventSource("/events/{{ batch_id }}");
      evt.onmessage = (e)=> renderRow(JSON.parse(e.data));
      evt.addEventListener('done', ()=>{ document.getElementById('status').textContent = '已全部完成 ✅'; });
      evt.onerror = ()=>{ document.getElementById('status').textContent = '连接中断，稍后会自动重连或手动刷新。'; };
    } else {
      let seen = 0;
      const timer = setInterval(async ()=>{
        const res = await fetch("/rows/{{ batch_id }}");
        const js = await res.json();
        while (seen < js.rows.length) { renderRow(js.rows[seen++]); }
        if (js.done) { clearInterval(timer); document.getElementById('status').textContent = '已全部完成 ✅'; }
      }, 1200);
    }
  </script>
</body>
</html>
