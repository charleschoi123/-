<!-- templates/results.html -->
<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <title>匹配结果（流式）</title>
  <link href="/static/style.css" rel="stylesheet" />
  <style>
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #eee;padding:8px;vertical-align:top}
    .muted{color:#6b7280}
    .err{color:#dc2626}
  </style>
</head>
<body>
<header class="hero small">
  <div class="brand">
    <div class="logo">AT</div>
    <h1>匹配结果</h1>
  </div>
</header>

<div class="container">
  <section class="card">
    <h2>JD 摘要</h2>
    <details open>
      <summary>展开/收起</summary>
      <pre style="white-space:pre-wrap">{{ jd }}</pre>
    </details>
    <h3 style="margin-top:12px">补充说明:</h3>
    <pre style="white-space:pre-wrap" class="muted">{{ notes }}</pre>
    <h3 style="margin-top:12px">Must-have识别:</h3>
    <pre style="white-space:pre-wrap">{{ must }}</pre>
  </section>

  <div class="actions">
    <a class="btn" href="/download_excel/{{ batch_id }}" target="_blank">⬇ 下载Excel</a>
    <a class="btn" href="/download_csv/{{ batch_id }}" target="_blank">⬇ 下载CSV</a>
    <a class="btn" href="/">返回</a>
  </div>

  <table id="tb" style="margin-top:12px">
    <thead>
      <tr>
        <th>文件名</th><th>姓名</th><th>年龄</th><th>教育背景</th><th>履历概要</th><th>亮点</th>
        <th>匹配度</th><th>匹配度分析</th><th>证据</th><th>状态</th>
        <th>技能</th><th>教育</th><th>经验</th><th>语言</th><th>稳定性</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <p class="muted" id="progress">正在分析中...</p>
</div>

<script>
  const tbody = document.querySelector('#tb tbody');
  function esc(s){return (s||'').toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
  function rowHtml(r){
    const d = r.data || {};
    const ss = d.subscores || {};
    const hl = (d.highlights||[]).join(' | ');
    const ev = (d.evidence||[]).join(' | ');
    const risks = (d.risk_notes||[]).join(' | ');
    const ok = r.ok !== false;
    return `<tr>
      <td>${esc(r.filename||'')}</td>
      <td>${esc(d.name||'未知')}</td>
      <td>${esc(d.estimated_age||'不详')}</td>
      <td>${esc(d.education_brief||'')}</td>
      <td>${esc(d.summary||'')}</td>
      <td>${esc(hl)}</td>
      <td>${esc(d.overall||0)}</td>
      <td>${esc((d.fit_analysis||'').replace(/\\n/g,' '))}</td>
      <td>${esc(ev)}</td>
      <td>${ok?'OK':('<span class="err">ERR</span> ' + esc(risks))}</td>
      <td>${esc(ss.skills||0)}</td>
      <td>${esc(ss.education||0)}</td>
      <td>${esc(ss.experience||0)}</td>
      <td>${esc(ss.language||0)}</td>
      <td>${esc(ss.stability||0)}</td>
    </tr>`;
  }

  const es = new EventSource("/events/{{ batch_id }}");
  es.onmessage = (e)=>{
    const r = JSON.parse(e.data);
    tbody.insertAdjacentHTML('beforeend', rowHtml(r));
  };
  es.addEventListener('done', ()=>{
    document.querySelector('#progress').textContent = '已完成，可下载报告。';
    es.close();
  });
</script>
</body>
</html>
